<?xml version="1.0" encoding="UTF-8"?>
<!-- Related XMLSchema file: conf/schemas/scenario.xsd -->
<!DOCTYPE Library [
  <!ENTITY register    SYSTEM "..\Library\register_provider.xml">
 ]>

<scenario>

	<parameter name="[clientName]" operation="set" value="[client_UAC]"/>
	<parameter name="[clientName2]" operation="set" value="[client_UAS]"/>
	<parameter name="[100_DOMAIN_ADDR]" operation="set" value="[domaine]"/>
	
	<parameter name="[LocalHost]" operation="setFromSystem" value="IPAddress" value2="eth0"/>
	<parameter name="[LocalPort]" operation="set" value="[port_UAC]"/>
	<parameter name="[LocalAddress]" operation="set" value="[LocalHost(0)]:[LocalPort(0)]"/>	
	<parameter name="[LocalTransport]" operation="set" value="udp"/>  
	
	<openProviderSIP name="open SIP provider" providerName="[scenarioName]" localPort="[LocalPort(0)]" transport="[LocalTransport]"/>

	<parameter name="[Expires]" 		operation="set" value="3600"/>
	<parameter name="[provider]" 		operation="set" value="[scenarioName]"/>
	
	&register;
	
	<parameter name="[testcase:SEM1]" operation="system.semaphorenotify"/>
	 <parameter name="[testcase:SEM4]" operation="system.semaphorewait"/>
	 
	 
	    <parameter name="[newCallID]" operation="identifier" value="newInteger" value2="10000000"/>	 
	 	<parameter name="[localTag]" operation="identifier" value="newString" value2="10"/>
	    <parameter name="[newCseq]" operation="add" value="[newCseq]" value2="1"/>			
	    <parameter name="[newBranchId]" operation="identifier" value="newString" value2="10"/>
	    
<sendRequestSIP name="Send Invite" providerName="[scenarioName]">
<![CDATA[INVITE sip:[clientName2]@[100_DOMAIN_ADDR] SIP/2.0
Call-ID: [newCallID]
CSeq: [newCseq] INVITE
From: "[clientName]"<sip:[clientName]@[100_DOMAIN_ADDR]>;tag=[localTag]
To: sip:[clientName2]@[100_DOMAIN_ADDR]
Via: SIP/2.0/UDP [LocalAddress];branch=z9hG4bK[newBranchId]
Max-Forwards: 70
Route: [SCSCF]
Contact: "[clientName]"<sip:[LocalAddress]>
Content-Type: application/sdp
P-Preferred-Identity: "[clientName]" <sip:[clientName]@[100_DOMAIN_ADDR]>
P-Access-Network-Info: 3GPP-UTRAN-TDD; utran-cell-id-3gpp=00000000
Privacy: none
User-Agent: Fraunhofer FOKUS/NGNI Java IMS UserEndpoint FoJIE 0.1 (jdk1.3)
Content-Length: x

v=0
o=[clientName2] 999 999 IN IP4 [LocalPort]]
s=-
c=IN IP4 [LocalPort]
t=0 0
m=audio 8000 RTP/AVP 0
]]>
</sendRequestSIP>	
   
   	
   
<receiveResponseSIP name="Wait 100 Trying" method="INVITE" result="100">
</receiveResponseSIP>

<receiveResponseSIP name="Wait 180 Ringing" method="INVITE" result="180">
</receiveResponseSIP>

<parameter name="[testcase:SEM11]" operation="system.semaphorenotify"/>
 
<receiveResponseSIP name="Wait 180 Ringing" method="INVITE" result="180">
</receiveResponseSIP>
 
<parameter name="[testcase:SEM20]" operation="system.semaphorenotify"/>
	
<receiveResponseSIP name="Wait 200 OK" method="INVITE" result="200">             
    <parameter name="[From]" 					operation="setFromMessage" 		value="header:From"/> 
	<parameter name="[To]"					 	operation="setFromMessage" 		value="header:To"/>	
    <parameter name="[CallId]" 					operation="setFromMessage" 		value="header:Call-Id"/> 
    <parameter name="[nextCseqNumber]" 			operation="add" 				value="[newCseq]" value2="1"/>   
    <parameter name="[nextNextCseqNumber]" 		operation="add" 				value="[nextCseqNumber]" value2="1"/>                               
    <parameter name="[Request-URI]" 			operation="setFromMessage" 		value="header:Contact:Address:URI"/>	
	<parameter name="[Record-Route]" 			operation="setFromMessage" 		value="header:Record-Route"/>	
	<parameter name="[Contact]" 				operation="setFromMessage" 		value="header:Contact"/>
</receiveResponseSIP> 
  
<parameter name="[Record-Route-Size]" operation="size" value="[Record-Route]"/>
<parameter name="[Record-Route-Inv]" operation="create" />
<while>
	<condition>
		<test parameter="[Record-Route-Size]" condition="greaterThan" value="0" />
	</condition>
	<do>
		<parameter name="[temp]" operation="getFirst" value="[Record-Route]" />
		<parameter name="[Record-Route]" operation="removeFirst" value="[Record-Route]" />
		<parameter name="[Record-Route-Inv]" operation="addFirst" value="[Record-Route-Inv]" value2="[temp]"/>
		<parameter name="[Record-Route-Size]" operation="size" value="[Record-Route]"/>
	</do>
</while>
    
<parameter name="[newBranchId]" operation="identifier" value="newString" value2="10"/>
	
<sendRequestSIP name="Send ACK" providerName="[scenarioName]">
<![CDATA[ACK [Request-URI] SIP/2.0
Max-Forwards: 70
Via: SIP/2.0/UDP [LocalAddress];branch=z9hG4bK[newBranchId]
From: [From]
To: [To]
CSeq: [newCseq] ACK
Call-ID: [newCallID]
Contact: "[clientName]"<sip:[LocalAddress]>
Route: [Record-Route-Inv]
P-Preferred-Identity: "[clientName]" <sip:[clientName]@[100_DOMAIN_ADDR]>
P-Access-Network-Info: 3GPP-UTRAN-TDD; utran-cell-id-3gpp=00000000
Privacy: none
User-Agent: [UserAgent]
P-Asserted-Identity: <sip:bob@ims.net>
Content-Length: 0
]]> 
</sendRequestSIP> 
  
<parameter name="[testcase:SEM5]" operation="system.semaphorewait" />

 
   	    <parameter name="[newCseq]" operation="add" value="[newCseq]" value2="1"/>		
  	    <parameter name="[newBranchId]" operation="identifier" value="newString" value2="10"/> 	    
  	    
 <sendRequestSIP name="Send BYE" providerName="[scenarioName]">
<![CDATA[BYE [Request-URI] SIP/2.0
Via: SIP/2.0/UDP [LocalAddress];branch=z9hG4bK[newBranchId]
Max-Forwards: 70
From: [From]
To: [To]
Call-ID: [newCallID]
CSeq: [newCseq] BYE
Route: [Record-Route-Inv]
Contact: "[clientName]"<sip:[LocalAddress]>
P-Preferred-Identity: "[clientName]" <sip:[clientName]@[100_DOMAIN_ADDR]>
P-Access-Network-Info: 3GPP-UTRAN-TDD; utran-cell-id-3gpp=00000000
Privacy: none
User-Agent: [UserAgent]
P-Asserted-Identity: <sip:bob@ims.net>
Content-Length: 0
]]>
  </sendRequestSIP>
                
  <receiveResponseSIP name="Wait 200 OK" method="BYE" result="200">
  </receiveResponseSIP>

  
  
  
<finally>   
	<parameter name="[Expires]" 		operation="set" value="0"/>
	&register;
	<parameter name="[testcase:SEM7]" operation="system.semaphorenotify"/>
	
 </finally> 
  
</scenario>