<?xml version="1.0" encoding="UTF-8"?>

<scenario>
  <!--send-->
  <parameter name="[local_port]" operation="set" value="[localPort(0)]"/>
  <parameter name="[remote_port]" operation="set" value="[remotePort(0)]"/>
  <createListenpointSIP name="_listenpoint[local_port]" localHost="[local_ip]" localPort="[local_port]"/>
  <if> 
    <condition> 
      <test parameter="[testcase:callNumber_0]" condition="list.exists"/>
    </condition>
    <then> 
      <parameter name="[testcase:callNumber_0]" operation="number.add" value="[testcase:callNumber_0]" value2="1"/>
    </then>
    <else> 
      <parameter name="[testcase:callNumber_0]" operation="set" value="0"/>
    </else>
  </if>
  <parameter name="[call_id]" operation="number.random" value="10000000"/>
  <parameter name="[pid]" operation="number.random" value="10000000"/>
  <parameter name="[local_ip_type]" operation="set" value="4"/>
  <!--send-->
  <parameter name="[branch]" operation="string.random" value="10"/>
  <sendMessageSIP listenpoint="_listenpoint[local_port]" remoteHost="[remote_ip]" remotePort="[remote_port]" state="SIP/2.0"><![CDATA[

      INVITE sip:[service]@[remote_ip]:[remote_port] SIP/2.0
      Via: SIP/2.0/[transport] [local_ip]:[local_port];branch=[branch]
      From: sipp <sip:sipp@[local_ip]:[local_port]>;tag=[pid]SIPpTag09[call_number]
      To: sut <sip:[service]@[remote_ip]:[remote_port]>
      Call-ID: [call_id]
      CSeq: 1 INVITE
      Contact: sip:sipp@[local_ip]:[local_port]
      Max-Forwards: 70
      Subject: Performance Test
      Content-Type: application/sdp
      Content-Length: [len]

      v=0
      o=user1 53655765 2353687637 IN IP[local_ip_type] [local_ip]
      s=-
      c=IN IP[local_ip_type] [local_ip]
      t=0 0
      m=audio [auto_media_port] RTP/AVP 8 101
      a=rtpmap:8 PCMA/8000
      a=rtpmap:101 telephone-event/8000
      a=fmtp:101 0-11,16

    ]]></sendMessageSIP>
  <!--recv-->
  <receiveMessageSIP listenpoint="_listenpoint[local_port]" timeout="[recv_timeout]"> 
    <parameter name="[_response]" operation="setFromMessage" value="message.result"/>
    <parameter name="[_request]" operation="setFromMessage" value="message.type"/>
    <or> 
      <test parameter="[_response]" condition="number.equals" value="200"/>
    </or>
    <parameter name="[last_Message]" operation="setFromMessage" value="Message"/>
  </receiveMessageSIP>
  <!--send-->
  <parameter name="[branch]" operation="string.random" value="10"/>
  <parameter name="[peer_tag_param]" operation="setFromMessage" value="header.To.parameter.tag" value2="[last_Message]"/>
  <parameter name="[peer_tag_param]" operation="set" value=";tag=[peer_tag_param]"/>
  <sendMessageSIP listenpoint="_listenpoint[local_port]" remoteHost="[remote_ip]" remotePort="[remote_port]" state="SIP/2.0"><![CDATA[

      ACK sip:[service]@[remote_ip]:[remote_port] SIP/2.0
      Via: SIP/2.0/[transport] [local_ip]:[local_port];branch=[branch]
      From: sipp <sip:sipp@[local_ip]:[local_port]>;tag=[pid]SIPpTag09[call_number]
      To: sut <sip:[service]@[remote_ip]:[remote_port]>[peer_tag_param]
      Call-ID: [call_id]
      CSeq: 1 ACK
      Contact: sip:sipp@[local_ip]:[local_port]
      Max-Forwards: 70
      Subject: Performance Test
      Content-Length: 0

    ]]></sendMessageSIP>
  <!--nop-->
  <!--exec-->
  <parameter name="[rtpflow]" operation="file.readmedia" value="pcap/g711a.pcap"/>
  <parameter name="[payloadList]" operation="set" value="[[rtpflow(0)]]" state="pcap/g711a.pcap"/>
  <parameter name="[timestampList]" operation="set" value="[[rtpflow(1)]]" state="pcap/g711a.pcap"/>
  <parameter name="[seqList]" operation="set" value="[[rtpflow(2)]]" state="pcap/g711a.pcap"/>
  <parameter name="[payloadType]" operation="set" value="[[rtpflow(3)]]" state="pcap/g711a.pcap"/>
  <parameter name="[deltaTime]" operation="set" value="[[rtpflow(4)]]" state="pcap/g711a.pcap"/>
  <parameter name="[markList]" operation="set" value="[[rtpflow(5)]]" state="pcap/g711a.pcap"/>
  <parameter name="[nbPacket]" operation="list.size" value="[payloadList]" state="pcap/g711a.pcap"/>
  <parameter name="[_SDPConnectionAddress]" operation="protocol.setFromMessage" value="content(0).Sdp.Connection.Address" value2="[last_Message]"/>
  <parameter name="[_SDPMediaPort]" operation="protocol.setFromMessage" value="content(0).Sdp.Media.Port" value2="[last_Message]"/>
  <createListenpointRTPFLOW name="sender" localHost="[local_ip]" localPort="[auto_media_port]"/>
  <sendMessageRTPFLOW listenpoint="sender" remoteHost="[_SDPConnectionAddress]" remotePort="[_SDPMediaPort]" state="pcap/g711a.pcap"> 
    <flow packetNumber="[nbPacket]" deltaTime="[deltaTime]"> 
      <header ssrc="148" payloadType="[payloadType]" seqnum="[seqList]" timestamp="[timestampList]" mark="[markList]"/>
      <payload format="binary">[payloadList]</payload>
    </flow>
  </sendMessageRTPFLOW>
  <!--pause-->
  <pause milliseconds="8000"/>
  <!--nop-->
  <!--exec-->
  <parameter name="[rtpflow]" operation="file.readmedia" value="pcap/dtmf_2833_1.pcap"/>
  <parameter name="[payloadList]" operation="set" value="[[rtpflow(0)]]" state="pcap/dtmf_2833_1.pcap"/>
  <parameter name="[timestampList]" operation="set" value="[[rtpflow(1)]]" state="pcap/dtmf_2833_1.pcap"/>
  <parameter name="[seqList]" operation="set" value="[[rtpflow(2)]]" state="pcap/dtmf_2833_1.pcap"/>
  <parameter name="[payloadType]" operation="set" value="[[rtpflow(3)]]" state="pcap/dtmf_2833_1.pcap"/>
  <parameter name="[deltaTime]" operation="set" value="[[rtpflow(4)]]" state="pcap/dtmf_2833_1.pcap"/>
  <parameter name="[markList]" operation="set" value="[[rtpflow(5)]]" state="pcap/dtmf_2833_1.pcap"/>
  <parameter name="[nbPacket]" operation="list.size" value="[payloadList]" state="pcap/dtmf_2833_1.pcap"/>
  <parameter name="[_SDPConnectionAddress]" operation="protocol.setFromMessage" value="content(0).Sdp.Connection.Address" value2="[last_Message]"/>
  <parameter name="[_SDPMediaPort]" operation="protocol.setFromMessage" value="content(0).Sdp.Media.Port" value2="[last_Message]"/>
  <createListenpointRTPFLOW name="sender" localHost="[local_ip]" localPort="[auto_media_port]"/>
  <sendMessageRTPFLOW listenpoint="sender" remoteHost="[_SDPConnectionAddress]" remotePort="[_SDPMediaPort]" state="pcap/dtmf_2833_1.pcap"> 
    <flow packetNumber="[nbPacket]" deltaTime="[deltaTime]"> 
      <header ssrc="148" payloadType="[payloadType]" seqnum="[seqList]" timestamp="[timestampList]" mark="[markList]"/>
      <payload format="binary">[payloadList]</payload>
    </flow>
  </sendMessageRTPFLOW>
  <!--pause-->
  <pause milliseconds="1000"/>
  <!--send-->
  <parameter name="[branch]" operation="string.random" value="10"/>
  <parameter name="[peer_tag_param]" operation="setFromMessage" value="header.To.parameter.tag" value2="[last_Message]"/>
  <parameter name="[peer_tag_param]" operation="set" value=";tag=[peer_tag_param]"/>
  <sendMessageSIP listenpoint="_listenpoint[local_port]" remoteHost="[remote_ip]" remotePort="[remote_port]" state="SIP/2.0"><![CDATA[

      BYE sip:[service]@[remote_ip]:[remote_port] SIP/2.0
      Via: SIP/2.0/[transport] [local_ip]:[local_port];branch=[branch]
      From: sipp <sip:sipp@[local_ip]:[local_port]>;tag=[pid]SIPpTag09[call_number]
      To: sut <sip:[service]@[remote_ip]:[remote_port]>[peer_tag_param]
      Call-ID: [call_id]
      CSeq: 2 BYE
      Contact: sip:sipp@[local_ip]:[local_port]
      Max-Forwards: 70
      Subject: Performance Test
      Content-Length: 0

    ]]></sendMessageSIP>
  <!--recv-->
  <receiveMessageSIP listenpoint="_listenpoint[local_port]" timeout="[recv_timeout]"> 
    <parameter name="[_response]" operation="setFromMessage" value="message.result"/>
    <parameter name="[_request]" operation="setFromMessage" value="message.type"/>
    <or> 
      <test parameter="[_response]" condition="number.equals" value="200"/>
    </or>
    <parameter name="[last_Message]" operation="setFromMessage" value="Message"/>
  </receiveMessageSIP>
  <!--ResponseTimeRepartition-->
  <!--CallLengthRepartition-->
</scenario>
