<?xml version="1.0" encoding="UTF-8"?>
<!-- Related XMLSchema file: conf/schemas/scenario.xsd -->
<!-- name="Send 3GPP Ro Credit-Control answer (CCA)"-->

<!--
From 3GPP TS 32.299 V7.5.0 :
Credit-Control-Answer ::= < Diameter Header: 272, PXY >
                             < Session-Id > 
                             { Result-Code } 
                             { Origin-Host } 
                             { Origin-Realm } 
                             { Auth-Application-Id } 
                             { CC-Request-Type } 
                             { CC-Request-Number } 
                   Not used  [ User-Name ] 
                             [ CC-Session-Failover ] 
                   Not used  [ CC-Sub-Session-Id ] 
                   Not used  [ Acct-Multi-Session-Id ] 
                   Not used  [ Origin-State-Id ] 
                   Not used  [ Event-Timestamp ] 
                   Not used  [ Granted-Service-Unit ] 
                               Granted-Service-Unit ::= < AVP Header: 431 >
                                                           [ Tariff-Time-Change ]
                                                           [ CC-Time ]
                                                           [ CC-Money ]
                                                             CC-Money ::= < AVP Header: 413 >
                                                                            { Unit-Value }
                                                                              Unit-Value ::= < AVP Header: 445 >
                                                                                               { Value-Digits }
                                                                                               [ Exponent ]
                                                                            [ Currency-Code ]
                                                           [ CC-Total-Octets ]
                                                           [ CC-Input-Octets ]
                                                           [ CC-Output-Octets ]
                                                           [ CC-Service-Specific-Units ]
                                                          *[ AVP ]
                            *[ Multiple-Services-Credit-Control ]  
                               Multiple-Services-Credit-Control ::= < AVP Header: 456 >
                                                                       [ Granted-Service-Unit ]
                                                                         Granted-Service-Unit ::= < AVP Header: 431 >
                                                                                                     [ Tariff-Time-Change ]
                                                                                                     [ CC-Time ]
                                                                                           Not used  [ CC-Money ]
                                                                                                       CC-Money ::= < AVP Header: 413 >
                                                                                                                      { Unit-Value }
                                                                                                                        Unit-Value ::= < AVP Header: 445 >
                                                                                                                                         { Value-Digits }
                                                                                                                                         [ Exponent ]
                                                                                                                      [ Currency-Code ]
                                                                                                     [ CC-Total-Octets ]
                                                                                                     [ CC-Input-Octets ]
                                                                                                     [ CC-Output-Octets ]
                                                                                                     [ CC-Service-Specific-Units ]
                                                                                                    *[ AVP ]
                                                             Not used  [ Requested-Service-Unit ]
                                                                         Requested-Service-Unit ::= < AVP Header: 437 >
                                                                                                       [ Tariff-Time-Change ]
                                                                                                       [ CC-Time ]
                                                                                                       [ CC-Money ]
                                                                                                         CC-Money ::= < AVP Header: 413 >
                                                                                                                        { Unit-Value }
                                                                                                                          Unit-Value ::= < AVP Header: 445 >
                                                                                                                                           { Value-Digits }
                                                                                                                                           [ Exponent ]
                                                                                                                        [ Currency-Code ]
                                                                                                       [ CC-Total-Octets ]
                                                                                                       [ CC-Input-Octets ]
                                                                                                       [ CC-Output-Octets ]
                                                                                                       [ CC-Service-Specific-Units ]
                                                                                                      *[ AVP ]
                                                                      *[ Used-Service-Unit ]
                                                                         Used-Service-Unit ::= < AVP Header: 446 >
                                                                                                  [ Tariff-Change-Usage ]
                                                                                                  [ CC-Time ]
                                                                                                  [ CC-Money ]
                                                                                                  [ CC-Total-Octets ]
                                                                                                  [ CC-Input-Octets ]
                                                                                                  [ CC-Output-Octets ]
                                                                                                  [ CC-Service-Specific-Units ]
                                                                                                 *[ AVP ]
                                                             Not used  [ Tariff-Change-Usage ]
                                                                      *[ Service-Identifier ]
                                                                       [ Rating-Group ]
                                                                      *[ G-S-U-Pool-Reference ]
                                                                         G-S-U-Pool-Reference ::= < AVP Header: 457 >
                                                                                                    { G-S-U-Pool-Identifier }
                                                                                                    { CC-Unit-Type }
                                                                                                    { Unit-Value }
                                                                                                      Unit-Value ::= < AVP Header: 445 >
                                                                                                                       { Value-Digits }
                                                                                                                       [ Exponent ]
                                                                       [ Validity-Time ]
                                                                       [ Result-Code ]
                                                                       [ Final-Unit-Indication ]
                                                                         Final-Unit-Indication ::= < AVP Header: 430 >
                                                                                                      { Final-Unit-Action }
                                                                                                     *[ Restriction-Filter-Rule ]
                                                                                                     *[ Filter-Id ]
                                                                                                      [ Redirect-Server ]
                                                                                                        Redirect-Server ::= < AVP Header: 434 >
                                                                                                                              { Redirect-Address-Type }
                                                                                                                              { Redirect-Server-Address }
                                                                       [ Time-Quota-Threshold ]
                                                                       [ Volume-Quota-Threshold ]
                                                                       [ Unit-Quota-Threshold ]
                                                                       [ Quota-Holding-Time ]
                                                                       [ Quota-Consumption-Time ]
                                                                      *[ Reporting-Reason ]
                                                                      *[ Trigger-Type ]
                                                                       [ PS-Furnish-Charging-Information ]
                                                                         PS-Furnish-Charging-Information ::= < AVP Header: 865  >
                                                                                                               { 3GPP-Charging-Id }
                                                                                                               { PS-Free-Format-Data }
                                                                                                               [ PS-Append-Free-Format-Data ]
                                                             Not used *[ AF-Correlation-Information ]
                                                                         AF-Correlation-Information ::= < AVP Header: 1276 >
                                                                                                           { AF-Charging-Identifier }
                                                                                                          *[ Flows ]
                                                                                                             Flows ::= < AVP Header: 510 >             
                                                                                                                          { Media-Component-Number}
                                                                                                                         *[ Flow-Number]
                                                                      *[ Envelope ]
                                                                         Envelope ::= < AVP Header: 1266 > 
                                                                                         { Envelope-Start-Time }
                                                                                         [ Envelope-End-Time ]
                                                                                         [ CC-Total-Octets ]
                                                                                         [ CC-Input-Octets ]
                                                                                         [ CC-Output-Octets ]
                                                                                         [ CC-Service-Specific-Units ]
                                                                                        *[ AVP ]
                                                                       [ Envelope-Reporting ]
                                                                       [ Time-Quota-Mechanism ]
                                                                         Time-Quota-Mechanism ::= < AVP Header: 1270 >
                                                                                                    { Time-Quota-Type }
                                                                                                    { Base-Time-Interval }
                                                             Not used *[ AVP ]
                             [ Cost-Information]  
                               Cost-Information ::= < AVP Header: 423 >
                                                      { Unit-Value }
                                                      { Currency-Code }
                                                      [ Cost-Unit ]
                   Not used  [ Final-Unit-Indication ]  
                               Final-Unit-Indication ::= < AVP Header: 430 >
                                                            { Final-Unit-Action }
                                                           *[ Restriction-Filter-Rule ]
                                                           *[ Filter-Id ]
                                                            [ Redirect-Server ]
                                                              Redirect-Server ::= < AVP Header: 434 >
                                                                                    { Redirect-Address-Type }
                                                                                    { Redirect-Server-Address }
                   Not used  [ Check-Balance-Result ]  
                             [ Credit-Control-Failure-Handling ] 
                             [ Direct-Debiting-Failure-Handling ] 
                   Not used  [ Validity-Time] 
                            *[ Redirect-Host] 
                             [ Redirect-Host-Usage ] 
                             [ Redirect-Max-Cache-Time ] 
                            *[ Proxy-Info ] 
                               Proxy-Info ::= < AVP Header: 284 >
                                                 { Proxy-Host }
                                                 { Proxy-State }
                                                *[ AVP ]
                            *[ Route-Record ] 
                            *[ Failed-AVP ]
                               Failed-AVP ::= < AVP Header: 279 >
                                                1* {AVP}
                             [ Service-Information ]
                               Service-Information :: = < AVP Header: 873>
                                                          [ Subscription-Id ]
                                                            Subscription-Id ::= < AVP Header: 443 >
                                                                                  { Subscription-Id-Data }
                                                                                  { Subscription-Id-Type }
                                                          [ PS-Information ]
                                                            PS-Information :: = < AVP Header: 874 >
                                                                                  [ 3GPP-Charging-Id ]
                                                                                  [ 3GPP-PDP-Type ]
                                                                                  [ PDP-Address ]
                                                                                  [ 3GPP-GPRS-Negotiated-QoS-Profile ]
                                                                                  [ SGSN-Address ]
                                                                                  [ GGSN-Address ]
                                                                                  [ CG-Address ]
                                                                                  [ 3GPP-IMSI-MCC-MNC ]
                                                                                  [ 3GPP-GGSN- MCC-MNC ]
                                                                                  [ 3GPP-NSAPI ]
                                                                                  [ Called-Station-Id ]
                                                                                 [ 3GPP-Session-Stop-Indicator ]
                                                                                  [ 3GPP-Selection-Mode ]
                                                                                  [ 3GPP-Charging-Characteristics ]
                                                                                  [ 3GPP-SGSN-MCC-MNC ]
                                                                                  [ 3GPP-MS-TimeZone ]
                                                                                 [ Charging-Rule-Base-Name ] 
                                                                                  [ 3GPP-User-Location-Info ]
                                                                                  [ 3GPP-RAT-Type ]
                                                                                  [ PS-Furnish-Charging-Information ]
                                                                                    PS-Furnish-Charging-Information ::= < AVP Header: 865 >
                                                                                                                          { 3GPP-Charging-Id }
                                                                                                                          { PS-Free-Format-Data }
                                                                                                                          [ PS-Append-Free-Format-Data ]
                                                                                  [ PDP-Context-Type ]
                                                         [ WLAN-Information ]
                                                           WLAN-Information :: = < AVP Header: 875 >
                                                                                   [ WLAN-Session-Id ]
                                                                                   [ PDG-Address ]
                                                                                   [ PDG-Charging-Id ]
                                                                                   [ WAG-Address ]
                                                                                   [ WAG-PLMN-Id ]
                                                                                   [ WLAN-Radio-Container ]
                                                                                     WLAN-Radio-Container ::= < AVP Header: 892 >
                                                                                                               [ Operator-Name ]
                                                                                                                [ Location-Type ]
                                                                                                                  Location-Type::= < AVP Header: 1244 >
                                                                                                                                     [ Location-Estimate-Type ]
                                                                                                                                     [ Deferred-Location-Event-Type ]
                                                                                                               [ Location-Information ]
                                                                                                                [ WLAN-Technology ]
                                                                                   [ WLAN-UE-Local-IPAddress ]
                                                         [ IMS-Information ]
                                                           IMS-Information :: = < AVP Header: 876 >
                                                                                   [ Event-Type ]
                                                                                     Event-Type ::= < AVP Header: 823 >
                                                                                                     [ SIP-Method ]
                                                                                                     [ Event ]
                                                                                                     [ Expires ]
                                                                                   [ Role-Of-Node ]
                                                                                   { Node-Functionality }
                                                                                   [ User-Session-ID ]
                                                                                  *[ Calling-Party-Address ]
                                                                                   [ Called-Party-Address ]
                                                                                  *[ Called-Asserted-Identity ]
                                                                                   [ Requested-Party-Address ]
                                                                                  *[ Associated-URI ]
                                                                                   [ Time-Stamps ]
                                                                                     Time-Stamps ::= < AVP Header: 833 >
                                                                                                       [ SIP-Request-Timestamp ]
                                                                                                       [ SIP-Response-Timestamp ]
                                                                                  *[ Application-Server-Information ]
                                                                                     Application-Server-Information ::= < AVP Header: 850 >
                                                                                                                           [ Application-Server ]
                                                                                                                          *[ Application-Provided-Called-Party-Address ]
                                                                                  *[ Inter-Operator-Identifier ]
                                                                                     Inter-Operator-Identifier ::= < AVP Header: 838 >
                                                                                                                     [ Originating-IOI ]
                                                                                                                     [ Terminating-IOI ]
                                                                                   [ IMS-Charging-Identifier ]
                                                                                  *[ SDP-Session-Description ]
                                                                                  *[ SDP-Media-Component ]       
                                                                                   [ Served-Party-IP-Address ]
                                                                                   [ Server-Capabilities ]
                                                                                     Server-Capabilities ::= < AVP header: 603 10415 >
                                                                                                               *[Mandatory-Capability]
                                                                                                               *[Optional-Capability]
                                                                                                               *[Server-Name]
                                                                                                               *[AVP]
                                                                                   [ Trunk-Group-ID ]
                                                                                     Trunk-Group-ID ::= < AVP Header: 851 >
                                                                                                          [ Incoming-Trunk-Group-ID ]
                                                                                                          [ Outgoing-Trunk-Group-ID ]
                                                                                   [ Bearer-Service ]
                                                                                   [ Service-Id ]
                                                                                  *[ Service-Specific-Info ]
                                                                                     Service-Specific-Info ::= < AVP Header: 1249 >
                                                                                                                 [ Service-Specific-Data ]
                                                                                                                 [ Service-Specific-Type ]
                                                                                  *[ Message-Body ]
                                                                                     Message-Body ::= < AVP Header: 889 >
                                                                                                        { Content-Type }
                                                                                                        { Content-Length }
                                                                                                        [ Content-Disposition ]
                                                                                                        [ Originator ]
                                                                                   [ Cause-Code ] 
                                                                                   [ Access-Network-Information ]
                                                                                  *[ Early-Media-Description]
                                                                                     Early-Media-Description ::= < AVP Header: 1272 >
                                                                                                                    [ SDP-TimeStamps ] 
                                                                                                                      SDP-TimeStamps ::= < AVP Header: 1273 >
                                                                                                                                           [ SDP-Offer-Timestamp ]
                                                                                                                                           [ SDP-Answer-Timestamp ]
                                                                                                                   *[ SDP-Media-Component ]
                                                                                                                      SDP-Media-Component ::= < AVP Header: 843 >
                                                                                                                                                 [ SDP-Media-Name ]
                                                                                                                                                *[ SDP-Media-Description ]
                                                                                                                                                 [ Media-Initiator-Flag ]
                                                                                                                                                 [ Authorized-QoS ]
                                                                                                                                                 [ 3GPP-Charging-Id ]
                                                                                                                                                 [ Access-Network-Charging-Identifier-Value ]
                                                         [ MMS-Information ]
                                                           MMS-Information :: = < AVP Header: 877>
                                                                                   [ Originator-Address ]
                                                                                     Originator-Address ::= < AVP Header: 886 >
                                                                                                              [ Address-Type ]
                                                                                                              [ Address-Data ]
                                                                                                              [ Address-Domain ]
                                                                                                                Address-Domain ::= < AVP Header: 898 >
                                                                                                                                     [ Domain-Name ]
                                                                                                                                     [ 3GPP-IMSI-MCC-MNC ]
                                                                                  *[ Recipient-Address ] 
                                                                                     Recipient-Address ::= < AVP Header: 1201 >
                                                                                                             [ Address-Type ]
                                                                                                             [ Address-Data ]
                                                                                                             [ Address-Domain ]
                                                                                                               Address-Domain ::= < AVP Header: 898 >
                                                                                                                                    [ Domain-Name ]
                                                                                                                                    [ 3GPP-IMSI-MCC-MNC ]
                                                                                                             [ Addressee-Type ]
                                                                                   [ Submission-Time ]
                                                                                   [ MM-Content-Type ]
                                                                                     MM-Content-Type ::= < AVP Header: 1203 >
                                                                                                             [ Type-Number ]
                                                                                                             [ Additional-Type-Information ]
                                                                                                             [ Content-Size ]
                                                                                                            *[ Additional-Content-Information ]
                                                                                                               Additional-Content-Information ::= < AVP Header: 1207 >
                                                                                                                                                    [ Type-Number ]
                                                                                                                                                    [ Additional-Type-Information ]
                                                                                                                                                    [ Content-Size ]
                                                                                   [ Priority ]
                                                                                   [ Message-ID ]
                                                                                   [ Message-Type ]
                                                                                   [ Message-Size ]
                                                                                   [ Message-Class ]
                                                                                     Message-Class ::= < AVP Header: 1213 >
                                                                                                         [ Class-Identifier ]
                                                                                                         [ Token-Text ]
                                                                                   [ Delivery-Report-Requested ]
                                                                                   [ Read-Reply-Report-Requested ]
                                                                                  [ MMBox-Storage-Information ]
                                                                                   [ Applic-ID ]
                                                                                   [ Reply-Applic-ID ]
                                                                                   [ Aux-Applic-Info ]
                                                                                   [ Content-Class ]
                                                                                   [ DRM-Content ]
                                                                                   [ Adaptations ]
                                                                                   [ VASP-Id ]
                                                                                   [ VAS-Id ]
                                                         [ LCS-Information ]
                                                           LCS-Information :: = < AVP Header: 878>
                                                                                  [ LCS-Client-ID ]
                                                                                    LCS-Client-ID ::= < AVP Header: 1232 >
                                                                                                        [ LCS-Client-Type ]
                                                                                                        [ LCS-Client-External-ID ]
                                                                                                        [ LCS-Client-Dialed-By-MS ]
                                                                                                        [ LCS-Client-Name ]
                                                                                                          LCS-Client-Name ::= < AVP Header: 1235 >
                                                                                                                                [ LCS-Data-Coding-Scheme ]
                                                                                                                                [ LCS-Name-String ]
                                                                                                                                [ LCS-Format-Indicator ]
                                                                                                        [ LCS-APN ]
                                                                                                        [ LCS-Requestor-ID ]
                                                                                                          LCS-Requestor-ID ::= < AVP Header: 1239 >
                                                                                                                                 [ LCS-Data-Coding-Scheme ]
                                                                                                                                 [ LCS-Requestor-ID-String ]
                                                                                  [ Location-Type ]
                                                                                    Location-Type::= < AVP Header: 1244 >
                                                                                                       [ Location-Estimate-Type ]
                                                                                                       [ Deferred-Location-Event-Type ]
                                                                                  [ Location-Estimate ]
                                                                                  [ Positioning-Data ]
                                                                                 [ IMSI ]
                                                                                  [ MSISDN ]
                                                         [ PoC-Information ]
                                                           PoC-Information :: = < AVP Header: 879>
                                                                                   [ PoC-Server-Role ]
                                                                                   [ PoC-Session-Type ]
                                                                                   [ PoC-User-Role]
                                                                                     PoC-User-Role ::= < AVP header: 1252 >
                                                                                                         [PoC-User-Role-IDs]
                                                                                                         [PoC-User-Role-info-Units]
                                                                                   [ PoC-Session-Initiation-type]
                                                                                   [ Number-Of-Participants ]
                                                                                  *[ Participants-Involved ]
                                                                                  *[ Talk-Burst-Exchange ]
                                                                                     Talk-Burst-Exchange ::= < AVP Header: 1255 >
                                                                                                               { PoC-Change-Time }
                                                                                                              [ Number-Of-Talk-Bursts ]
                                                                                                              [ Talk-Burst-Volume ]
                                                                                                              [ Talk Bursts-Time ]
                                                                                                              [ Number-Of-Received-Talk-Bursts ]
                                                                                                              [ Received-Talk-Burst-Volume ]
                                                                                                              [ Received-Talk-Burst-Time ]
                                                                                                               [ Number-Of-Participants ]
                                                                                                               [ PoC-Change-Condition ]
                                                                                   [ PoC-Controlling-Address ] 
                                                                                   [ PoC-Group-Name ]
                                                                                   [ PoC-Session-Id ] 
                                                                                   [ Charged-Party ]
                                                         [ MBMS-Information ]
                                                           MBMS-Information :: = < AVP Header: 880>
                                                                                    [ TMGI ]
                                                                                    [ MBMS-Service-Type ]
                                                                                    [ MBMS-User-Service-Type ]
                                                                                    [ File-Repair-Supported ]
                                                                                    [ Required-MBMS-Bearer-Capabilities ]
                                                                                    [ MBMS-2G-3G-Indicator ]
                                                                                    [ RAI ]
                                                                                   *[ MBMS-Service-Area ]
                                                                                    [ MBMS-Session-Identity ]
                                                         [ Service-Generic-Information ]
                            *[ AVP ]

-->
<scenario>

  <!-- Loading subscribers datas. -->
  <parameter name="[csvPathSubscribers]" operation="set" value="Subscribers.csv" />
  <parameter name="[numberOfSubscriber]" operation="file.readCsv" value="[csvPathSubscribers]" value2="subscriberNumber" />
  <parameter name="[creditOfSubscriber]" operation="setFromCsv" value="[csvPathSubscribers]" value2="initialCreditTime" />
  <parameter name="[grantedTimeOfSubscriber]" operation="setFromCsv" value="[csvPathSubscribers]" value2="grantedSlideTime" />

  <!-- Processing Credit-Control Requests. -->
	<label name="Begin"/>
    <!-- Receiving CCR. -->
    <receiveMessageDIAMETER name="Receive Request 3GPP/Ro/CCR" request="true" timeout="0">
      <parameter name="hopByHop" operation="protocol.setFromMessage" value="header.hopByHop"/>
      <parameter name="endToEnd" operation="protocol.setFromMessage" value="header.endToEnd"/>
      <parameter name="Pbit" operation="protocol.setFromMessage" value="header.proxiable"/>
  		<parameter name="Session-Id" operation="protocol.setFromMessage" value="avp.Session-Id.value"/>
  		<parameter name="CC-Request-Type" operation="protocol.setFromMessage" value="avp.CC-Request-Type.value"/>
  		<parameter name="CC-Request-Number" operation="protocol.setFromMessage" value="avp.CC-Request-Number.value"/>
  		<parameter name="Subscription-Id-Data" operation="protocol.setFromMessage" value="avp.Subscription-Id.Subscription-Id-Data.value"/>
  		<parameter name="usedCC-Time" operation="protocol.setFromMessage" value="avp.Multiple-Services-Credit-Control.Used-Service-Unit.CC-Time.value"/>
  		<parameter name="Proxy-Host" operation="protocol.setFromMessage" value="avp.Proxy-Info.Proxy-Host.value"/>
  		<parameter name="Proxy-State" operation="protocol.setFromMessage" value="avp.Proxy-Info.Proxy-State.value"/>
    </receiveMessageDIAMETER>

    <!-- Extracting subscriber number from SIP URI "sip:+33xxxxxxxxx@[userDomain]". -->
    <!-- Attention : En IMSLoader V4.8, value3=16 au lieu de 15. Corrige en V4.9. -->
    <parameter name="subscriberNumber" operation="string.substring" value="[Subscription-Id-Data]" value2="7" value3="15"/>
    <log level="DEBUG">subscriberNumber=[subscriberNumber].</log>

    <!-- Finding the subscriber's index. -->
    <parameter name="subscriberIndex" operation="list.find" value="[numberOfSubscriber]" value2="[subscriberNumber]"/>

    <!-- Sending CCA. -->
    <if><condition><test parameter="[subscriberIndex]" condition="list.isEmpty" value="true"/></condition>
      <then>
        <!-- Unknown subscriber : DIAMETER_UNKNOWN_SESSION_ID result code. -->
        <sendMessageDIAMETER name="Send Answer 3GPP/Ro/CCA">
          <!-- RFC 3588 : The 'P' bit is set to the same value as the one in the request. -->
          <!-- RFC 3588 : The same Hop-by-Hop identifier in the request is used in the answer. -->
          <!-- RFC 3588 : The same End-to-End identifier in the request is used in the answer. -->
          <header request="false" command="Credit-Control" applicationId="4" proxiable="[Pbit]" error="false" retransmit="false" hopByHop="[hopByHop]" endToEnd="[endToEnd]"/>

          <!-- RFC 3588 : If the Session-Id is present in the request, it MUST be included in the answer. -->
          <avp code="Session-Id" mandatory="true" type="UTF8String" value="[Session-Id]"/>

          <!-- RFC 3588 : The Result-Code AVP is added with its value indicating success or failure. -->
          <avp code="Result-Code" mandatory="true" type="Unsigned32" value="DIAMETER_UNKNOWN_SESSION_ID"/>              

          <!-- RFC 3588 : The local host's identity is encoded in the Origin-Host AVP. -->
          <avp code="Origin-Host" mandatory="true" type="DiameterIdentity" value="[Remote-Host]"/>
          <avp code="Origin-Realm" mandatory="true" type="DiameterIdentity" value="[Remote-Realm]"/>
          <!-- RFC 3588 : The Destination-Host and Destination-Realm AVPs MUST NOT be present in the answer message. -->

          <!-- The Auth-Application-Id AVP is used in order to advertise support of the Authentication and Authorization portion of an application. -->
          <avp code="Auth-Application-Id" mandatory="true" type="Unsigned32" value="4"/>

          <!-- The CC-Request-Type AVP defines the transfer type: event for event based charging and initial, update, terminate for session based charging. -->
          <!-- Possible enumerated values : INITIAL_REQUEST(1) / UPDATE_REQUEST(2) / TERMINATION_REQUEST(3) / EVENT_REQUEST(4). -->
          <avp code="CC-Request-Type" mandatory="true" type="Enumerated" value="[CC-Request-Type]"/>

          <!-- The CC-Request-Number AVP contains the sequence number of the transferred messages. -->
          <avp code="CC-Request-Number" mandatory="true" type="Unsigned32" value="[CC-Request-Number]"/>

          <!-- RFC 3588 : Any Proxy-Info AVPs in the request MUST be added to the answer message, in the same order they were present in the request. -->
        </sendMessageDIAMETER>
        <goto  name="loop" label="Begin" state="true"/>
      </then>
      <else><!-- Known subscriber : DIAMETER_SUCCESS result code. -->
      <!-- Update credit before sending the CCA. -->
      <!-- Possible enumerated values : INITIAL_REQUEST(1) / UPDATE_REQUEST(2) / TERMINATION_REQUEST(3) / EVENT_REQUEST(4). -->
      <if>
        <condition>
          <or>
            <test parameter="[CC-Request-Type]" condition="number.equals" value="2"/>
            <test parameter="[CC-Request-Type]" condition="number.equals" value="3"/>
          </or>
        </condition>
        <then>
          <parameter name="[creditOfSubscriber([subscriberIndex])]" operation="number.substract" value="[creditOfSubscriber([subscriberIndex])]" value2="[usedCC-Time]"/>
        </then>
      </if>

       <if><condition><test parameter="[creditOfSubscriber([subscriberIndex])]" condition="number.lowerThan" value="[grantedTimeOfSubscriber([subscriberIndex])]"/></condition>
          <then>
            <!-- Sendinding CCA with Final-Unit-Indication AVP. -->
            <sendMessageDIAMETER name="Send Answer 3GPP/Ro/CCA">
              <!-- RFC 3588 : The 'P' bit is set to the same value as the one in the request. -->
              <!-- RFC 3588 : The same Hop-by-Hop identifier in the request is used in the answer. -->
              <!-- RFC 3588 : The same End-to-End identifier in the request is used in the answer. -->
              <header request="false" command="Credit-Control" applicationId="4" proxiable="[Pbit]" error="false" retransmit="false" hopByHop="[hopByHop]" endToEnd="[endToEnd]"/>

              <!-- RFC 3588 : If the Session-Id is present in the request, it MUST be included in the answer. -->
              <avp code="Session-Id" mandatory="true" type="UTF8String" value="[Session-Id]"/>

              <!-- RFC 3588 : The Result-Code AVP is added with its value indicating success or failure. -->
              <avp code="Result-Code" mandatory="true" type="Unsigned32" value="DIAMETER_SUCCESS"/>              

              <!-- RFC 3588 : The local host's identity is encoded in the Origin-Host AVP. -->
              <avp code="Origin-Host" mandatory="true" type="DiameterIdentity" value="[Remote-Host]"/>
              <avp code="Origin-Realm" mandatory="true" type="DiameterIdentity" value="[Remote-Realm]"/>
              <!-- RFC 3588 : The Destination-Host and Destination-Realm AVPs MUST NOT be present in the answer message. -->

              <!-- The Auth-Application-Id AVP is used in order to advertise support of the Authentication and Authorization portion of an application. -->
              <avp code="Auth-Application-Id" mandatory="true" type="Unsigned32" value="4"/>

              <!-- The CC-Request-Type AVP defines the transfer type: event for event based charging and initial, update, terminate for session based charging. -->
              <!-- Possible enumerated values : INITIAL_REQUEST(1) / UPDATE_REQUEST(2) / TERMINATION_REQUEST(3) / EVENT_REQUEST(4). -->
              <avp code="CC-Request-Type" mandatory="true" type="Enumerated" value="[CC-Request-Type]"/>

              <!-- The CC-Request-Number AVP contains the sequence number of the transferred messages. -->
              <avp code="CC-Request-Number" mandatory="true" type="Unsigned32" value="[CC-Request-Number]"/>

              <!-- The Multiple-Services-Credit-Control AVP contains additional 3GPP specific charging parameters. -->
              <avp code="Multiple-Services-Credit-Control">
                <!-- The Granted-Service-Unit AVP contains the amount of units that the Diameter credit-control client can provide to the end user until the service must be released or the new Credit-Control-Request must be sent. -->
                <avp code="Granted-Service-Unit">
                  <!-- The CC-Time AVP indicates the length of the requested, granted, or used time in seconds. -->
                  <avp code="CC-Time" mandatory="true" type="Unsigned32" value="[creditOfSubscriber([subscriberIndex])]"/>
                </avp>

                <!-- The Final-Unit-Indication AVP indicates that the Granted-Service-Unit AVP in the Credit-Control-Answer, or in the AA answer, contains the final units for the service. -->
                <avp code="Final-Unit-Indication">
                  <!-- The Final-Unit-Action AVP indicates to the credit-control client the action to be taken when the user's account cannot cover the service cost. -->
                  <!-- Possible enumerated values : TERMINATE(0) / REDIRECT(1) / RESTRICT_ACCESS(2). -->
                  <avp code="Final-Unit-Action" mandatory="true" type="Enumerated" value="TERMINATE"/>
                </avp>
              </avp>

              <!-- RFC 3588 : Any Proxy-Info AVPs in the request MUST be added to the answer message, in the same order they were present in the request. -->
            </sendMessageDIAMETER>
            <goto  name="loop" label="Begin" state="true"/>
          </then>
          <else>
            <!-- Sendinding CCA without Final-Unit-Indication AVP. -->
            <sendMessageDIAMETER name="Send Answer 3GPP/Ro/CCA">
              <!-- RFC 3588 : The 'P' bit is set to the same value as the one in the request. -->
              <!-- RFC 3588 : The same Hop-by-Hop identifier in the request is used in the answer. -->
              <!-- RFC 3588 : The same End-to-End identifier in the request is used in the answer. -->
              <header request="false" command="Credit-Control" applicationId="4" proxiable="[Pbit]" error="false" retransmit="false" hopByHop="[hopByHop]" endToEnd="[endToEnd]"/>

              <!-- RFC 3588 : If the Session-Id is present in the request, it MUST be included in the answer. -->
              <avp code="Session-Id" mandatory="true" type="UTF8String" value="[Session-Id]"/>

              <!-- RFC 3588 : The Result-Code AVP is added with its value indicating success or failure. -->
              <avp code="Result-Code" mandatory="true" type="Unsigned32" value="DIAMETER_SUCCESS"/>              

              <!-- RFC 3588 : The local host's identity is encoded in the Origin-Host AVP. -->
              <avp code="Origin-Host" mandatory="true" type="DiameterIdentity" value="[Remote-Host]"/>
              <avp code="Origin-Realm" mandatory="true" type="DiameterIdentity" value="[Remote-Realm]"/>
              <!-- RFC 3588 : The Destination-Host and Destination-Realm AVPs MUST NOT be present in the answer message. -->

              <!-- The Auth-Application-Id AVP is used in order to advertise support of the Authentication and Authorization portion of an application. -->
              <avp code="Auth-Application-Id" mandatory="true" type="Unsigned32" value="4"/>

              <!-- The CC-Request-Type AVP defines the transfer type: event for event based charging and initial, update, terminate for session based charging. -->
              <!-- Possible enumerated values : INITIAL_REQUEST(1) / UPDATE_REQUEST(2) / TERMINATION_REQUEST(3) / EVENT_REQUEST(4). -->
              <avp code="CC-Request-Type" mandatory="true" type="Enumerated" value="[CC-Request-Type]"/>

              <!-- The CC-Request-Number AVP contains the sequence number of the transferred messages. -->
              <avp code="CC-Request-Number" mandatory="true" type="Unsigned32" value="[CC-Request-Number]"/>

              <!-- The Multiple-Services-Credit-Control AVP contains additional 3GPP specific charging parameters. -->
              <avp code="Multiple-Services-Credit-Control">
                <!-- The Granted-Service-Unit AVP contains the amount of units that the Diameter credit-control client can provide to the end user until the service must be released or the new Credit-Control-Request must be sent. -->
                <avp code="Granted-Service-Unit">
                  <!-- The CC-Time AVP indicates the length of the requested, granted, or used time in seconds. -->
                  <avp code="CC-Time" mandatory="true" type="Unsigned32" value="[grantedTimeOfSubscriber([subscriberIndex])]"/>
                </avp>
              </avp>

              <!-- RFC 3588 : Any Proxy-Info AVPs in the request MUST be added to the answer message, in the same order they were present in the request. -->
            </sendMessageDIAMETER>
            <goto  name="loop" label="Begin" state="true"/>
          </else>
        </if>
      </else>
    </if>
    
</scenario>
